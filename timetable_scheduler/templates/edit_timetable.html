{% extends "base.html" %}

{% block title %}Edit Timetable - {{ batch.name }} - College Timetable Scheduler{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Edit Timetable</h1>
                <p class="text-gray-600 mt-2">Click on any cell to add/edit classes for {{ batch.name }}</p>
            </div>
            <div class="flex space-x-3">
                <a href="{{ url_for('view_timetable', batch_id=batch.id) }}" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition duration-200">
                    <i class="fas fa-arrow-left mr-2"></i>Back to View
                </a>
                <button onclick="saveAllChanges()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition duration-200">
                    <i class="fas fa-save mr-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="bg-blue-50 rounded-lg p-4">
        <div class="flex items-center">
            <i class="fas fa-info-circle text-blue-500 mr-3"></i>
            <div class="text-sm text-blue-800">
                <strong>Instructions:</strong> Click on any time slot to add a new class, or click on existing classes to edit/delete them. 
                For 2-hour lab sessions, schedule them in the appropriate combined time slots (e.g., 09:15-11:15).
            </div>
        </div>
    </div>

    <!-- Timetable Editor -->
    <div class="bg-white rounded-lg shadow-md overflow-hidden">
        <div class="px-6 py-4 bg-gray-50 border-b">
            <h2 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-edit text-college-blue mr-2"></i>Interactive Timetable Editor
            </h2>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-college-blue">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">Time</th>
                        {% for day in days %}
                            <th class="px-4 py-3 text-left text-xs font-medium text-white uppercase tracking-wider">{{ day }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% set skip_cells = {} %}
                    {% for time_slot in time_slots %}
                        {% set is_lunch = time_slot == '12:15-01:00' %}
                        <tr class="{% if is_lunch %}bg-yellow-50{% else %}hover:bg-gray-50{% endif %}">
                            <td class="px-4 py-4 whitespace-nowrap text-sm font-medium text-gray-900 bg-gray-50">
                                {{ time_slot }}
                                {% if is_lunch %}
                                    <span class="block text-xs text-yellow-600">Lunch Break</span>
                                {% endif %}
                            </td>
                            {% for day in days %}
                                {% set skip_key = day + '_' + time_slot %}
                                {% if skip_key not in skip_cells %}
                                    {% set rowspan = 1 %}
                                    {% set entry = None %}
                                    {% set is_lab_start = false %}
                                    {% set lab_time_slot = time_slot %}
                                    
                                    {% if is_lunch %}
                                        <!-- Lunch break cell - not editable -->
                                        <td class="px-4 py-4 text-sm text-gray-500 border-r border-gray-200">
                                            <div class="text-center text-yellow-600 font-medium py-4">
                                                <i class="fas fa-utensils text-2xl mb-2"></i>
                                                <div class="text-sm">LUNCH BREAK</div>
                                            </div>
                                        </td>
                                    {% else %}
                                        <!-- Check for lab sessions that start in this slot -->
                                        {% if time_slot == '09:15-10:15' and timetable[day]['09:15-11:15'] %}
                                            {% set entry = timetable[day]['09:15-11:15'] %}
                                            {% set rowspan = 2 %}
                                            {% set is_lab_start = true %}
                                            {% set lab_time_slot = '09:15-11:15' %}
                                            {% set _ = skip_cells.update({(day + '_10:15-11:15'): true}) %}
                                        {% elif time_slot == '10:15-11:15' and timetable[day]['10:15-12:15'] %}
                                            {% set entry = timetable[day]['10:15-12:15'] %}
                                            {% set rowspan = 2 %}
                                            {% set is_lab_start = true %}
                                            {% set lab_time_slot = '10:15-12:15' %}
                                            {% set _ = skip_cells.update({(day + '_11:15-12:15'): true}) %}
                                        {% elif time_slot == '01:00-02:00' and timetable[day]['01:00-03:00'] %}
                                            {% set entry = timetable[day]['01:00-03:00'] %}
                                            {% set rowspan = 2 %}
                                            {% set is_lab_start = true %}
                                            {% set lab_time_slot = '01:00-03:00' %}
                                            {% set _ = skip_cells.update({(day + '_02:00-03:00'): true}) %}
                                        {% elif time_slot == '02:00-03:00' and timetable[day]['02:00-04:00'] %}
                                            {% set entry = timetable[day]['02:00-04:00'] %}
                                            {% set rowspan = 2 %}
                                            {% set is_lab_start = true %}
                                            {% set lab_time_slot = '02:00-04:00' %}
                                            {% set _ = skip_cells.update({(day + '_03:00-04:00'): true}) %}
                                        {% else %}
                                            {% set entry = timetable[day][time_slot] %}
                                            {% set lab_time_slot = time_slot %}
                                        {% endif %}
                                        
                                        <td class="px-2 py-2 text-sm text-gray-500 border-r border-gray-200 cursor-pointer hover:bg-blue-50 transition-colors" 
                                            {% if rowspan > 1 %}rowspan="{{ rowspan }}"{% endif %}
                                            onclick="openEditModal('{{ day }}', '{{ lab_time_slot }}', {{ entry|tojson if entry else 'null' }})">
                                            {% if entry %}
                                                {% if entry.type == 'practical' and is_lab_start %}
                                                    <!-- 2-hour Lab session -->
                                                    <div class="p-3 rounded-lg bg-blue-50 border-l-4 border-blue-500">
                                                        <div class="font-bold text-blue-900 mb-1">{{ entry.subject }} LAB</div>
                                                        <div class="text-xs text-blue-700 mb-1">
                                                            <i class="fas fa-user-tie mr-1"></i>{{ entry.faculty }}
                                                        </div>
                                                        <div class="text-xs text-blue-700 mb-1">
                                                            <i class="fas fa-door-open mr-1"></i>{{ entry.classroom }}
                                                        </div>
                                                        <div class="text-xs font-medium text-blue-800 bg-blue-200 px-2 py-1 rounded-full text-center">
                                                            2 Hour Lab
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <!-- Regular class -->
                                                    <div class="p-2 rounded-lg {% if entry.type == 'practical' %}bg-blue-50 border border-blue-200{% elif entry.type == 'tutorial' %}bg-yellow-50 border border-yellow-200{% else %}bg-green-50 border border-green-200{% endif %}">
                                                        <div class="font-semibold text-gray-900 text-sm mb-1">{{ entry.subject }}</div>
                                                        <div class="text-xs text-gray-600 mb-1">
                                                            <i class="fas fa-user-tie mr-1"></i>{{ entry.faculty }}
                                                        </div>
                                                        <div class="text-xs text-gray-600 mb-1">
                                                            <i class="fas fa-door-open mr-1"></i>{{ entry.classroom }}
                                                        </div>
                                                        <div class="text-xs font-medium {% if entry.type == 'practical' %}text-blue-700 bg-blue-100{% elif entry.type == 'tutorial' %}text-yellow-700 bg-yellow-100{% else %}text-green-700 bg-green-100{% endif %} px-1 py-0.5 rounded text-center">
                                                            {{ entry.type.title() }}
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            {% else %}
                                                <div class="text-center text-gray-400 py-6 hover:text-blue-500 transition-colors">
                                                    <i class="fas fa-plus text-xl mb-2"></i>
                                                    <div class="text-xs">Click to Add</div>
                                                </div>
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Edit Time Slot</h3>
                <p id="modalSubtitle" class="text-sm text-gray-600 mt-1"></p>
            </div>
            <form id="editForm" class="px-6 py-4 space-y-4">
                <input type="hidden" id="batchId" value="{{ batch.id }}">
                <input type="hidden" id="entryId" value="">
                <input type="hidden" id="currentDay" value="">
                <input type="hidden" id="currentTimeSlot" value="">
                
                <div>
                    <label for="subjectSelect" class="block text-sm font-medium text-gray-700 mb-2">Subject</label>
                    <select id="subjectSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-college-blue">
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                            <option value="{{ subject.id }}" data-type="{{ subject.type }}">{{ subject.name }} ({{ subject.type.title() }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="facultySelect" class="block text-sm font-medium text-gray-700 mb-2">Faculty</label>
                    <select id="facultySelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-college-blue">
                        <option value="">Select Faculty</option>
                        {% for faculty in faculties %}
                            <option value="{{ faculty.id }}">{{ faculty.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div>
                    <label for="classroomSelect" class="block text-sm font-medium text-gray-700 mb-2">Classroom</label>
                    <select id="classroomSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-college-blue">
                        <option value="">Select Classroom</option>
                        {% for classroom in classrooms %}
                            <option value="{{ classroom.id }}">{{ classroom.name }} (Capacity: {{ classroom.capacity }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div id="labWarning" class="hidden bg-yellow-50 border border-yellow-200 rounded-md p-3">
                    <div class="flex">
                        <i class="fas fa-exclamation-triangle text-yellow-400 mr-2 mt-0.5"></i>
                        <div class="text-sm text-yellow-700">
                            <strong>Lab Session:</strong> This will create a 2-hour laboratory session spanning two time periods.
                        </div>
                    </div>
                </div>
            </form>
            
            <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between">
                <div>
                    <button id="deleteBtn" onclick="deleteEntry()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition duration-200 hidden">
                        <i class="fas fa-trash mr-2"></i>Delete
                    </button>
                </div>
                <div class="flex space-x-3">
                    <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600 transition duration-200">
                        Cancel
                    </button>
                    <button onclick="saveEntry()" class="bg-college-blue text-white px-4 py-2 rounded-md hover:bg-college-dark transition duration-200">
                        <i class="fas fa-save mr-2"></i>Save
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentEntry = null;

function openEditModal(day, timeSlot, entry) {
    currentEntry = entry;
    
    document.getElementById('currentDay').value = day;
    document.getElementById('currentTimeSlot').value = timeSlot;
    document.getElementById('modalSubtitle').textContent = `${day} ${timeSlot}`;
    
    if (entry) {
        document.getElementById('modalTitle').textContent = 'Edit Class';
        document.getElementById('entryId').value = entry.id || '';
        document.getElementById('subjectSelect').value = entry.subject_id || '';
        document.getElementById('facultySelect').value = entry.faculty_id || '';
        document.getElementById('classroomSelect').value = entry.classroom_id || '';
        document.getElementById('deleteBtn').classList.remove('hidden');
    } else {
        document.getElementById('modalTitle').textContent = 'Add New Class';
        document.getElementById('entryId').value = '';
        document.getElementById('subjectSelect').value = '';
        document.getElementById('facultySelect').value = '';
        document.getElementById('classroomSelect').value = '';
        document.getElementById('deleteBtn').classList.add('hidden');
    }
    
    updateLabWarning();
    document.getElementById('editModal').classList.remove('hidden');
}

function closeModal() {
    document.getElementById('editModal').classList.add('hidden');
    currentEntry = null;
}

function updateLabWarning() {
    const subjectSelect = document.getElementById('subjectSelect');
    const selectedOption = subjectSelect.options[subjectSelect.selectedIndex];
    const subjectType = selectedOption.getAttribute('data-type');
    const timeSlot = document.getElementById('currentTimeSlot').value;
    
    const labWarning = document.getElementById('labWarning');
    const isLabTimeSlot = ['09:15-11:15', '10:15-12:15', '01:00-03:00', '02:00-04:00'].includes(timeSlot);
    
    if (subjectType === 'practical' && isLabTimeSlot) {
        labWarning.classList.remove('hidden');
    } else {
        labWarning.classList.add('hidden');
    }
}

document.getElementById('subjectSelect').addEventListener('change', updateLabWarning);

function saveEntry() {
    const batchId = document.getElementById('batchId').value;
    const entryId = document.getElementById('entryId').value;
    const day = document.getElementById('currentDay').value;
    const timeSlot = document.getElementById('currentTimeSlot').value;
    const subjectId = document.getElementById('subjectSelect').value;
    const facultyId = document.getElementById('facultySelect').value;
    const classroomId = document.getElementById('classroomSelect').value;
    
    if (!subjectId || !facultyId || !classroomId) {
        alert('Please fill in all fields');
        return;
    }
    
    const action = entryId ? 'update' : 'add';
    
    fetch('/update_timetable_entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            batch_id: batchId,
            entry_id: entryId,
            day: day,
            time_slot: timeSlot,
            subject_id: subjectId,
            faculty_id: facultyId,
            classroom_id: classroomId,
            action: action
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // Reload to show updated timetable
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while saving');
    });
}

function deleteEntry() {
    if (!currentEntry || !currentEntry.id) {
        alert('No entry to delete');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this class?')) {
        return;
    }
    
    fetch('/update_timetable_entry', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            entry_id: currentEntry.id,
            action: 'delete'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting');
    });
}

function saveAllChanges() {
    alert('All changes have been saved automatically. Students will see the updated timetable immediately.');
    window.location.href = '{{ url_for("view_timetable", batch_id=batch.id) }}';
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeModal();
    }
});
</script>
{% endblock %}